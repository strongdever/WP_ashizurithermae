!function(e){e(document).on("sowsetupformfield",".siteorigin-widget-field-type-media",(function(t){var i=e(this),a=i.find("> .media-field-wrapper"),n=i.find(".siteorigin-widget-input").not(".media-fallback-external"),s=i.find(".media-fallback-external");if(!a.data("initialized")){var r;a.find(".media-upload-button").on("click",(function(t){if(t.preventDefault(),void 0!==wp.media){var a=e(this),s=e(this).data("frame");if(s)return s.open(),!1;(s=wp.media({title:a.data("choose"),library:{type:a.data("library").split(",").map((function(e){return e.trim()}))},button:{text:a.data("update"),close:!1}})).on("open",(function(){var e=s.state().get("selection"),t=i.find('.siteorigin-widget-input[type="hidden"]').val();t&&e.add(wp.media.attachment(t))})),a.data("frame",s),s.on("select",(function(){var e=s.state().get("selection").first().attributes;i.find(".current .thumbnail").attr("title",e.title),i.find(".current .title").html(e.title),n.val(e.id),n.trigger("change",{silent:!0});var t=i.find(".current .thumbnail");void 0!==e.sizes?void 0!==e.sizes.thumbnail?t.attr("src",e.sizes.thumbnail.url).fadeIn():t.attr("src",e.sizes.full.url).fadeIn():t.attr("src",e.icon).fadeIn(),i.find(".media-remove-button").removeClass("remove-hide").attr("tabindex",0),s.close()})),s.open()}})),i.find("a.media-remove-button").on("click",(function(t){t.preventDefault(),n.val(""),i.find(".current .title").empty(),n.trigger("change",{silent:!0}),i.find(".current .thumbnail").fadeOut("fast"),e(this).addClass("remove-hide").attr("tabindex",-1)}));var o=function(){if(r){var e=r.find(".so-widgets-image-results");if(0!==e.length){var t=e.width(),i=Math.floor(t/276),a=(t-276*i)/i+260;e.find(".so-widgets-result-image").css({width:a+"px",height:a/1.4+"px"})}}};e(window).on("resize",o);a.find(".find-image-button").on("click",(function(t){t.preventDefault(),function(){if(!r){(r=e(e("#so-widgets-bundle-tpl-image-search-dialog").html().trim()).appendTo("body")).find(".close").on("click keyup",(function(e){("keyup"!=e.type||window.sowbForms.isEnter(e))&&r.hide()}));var t,a=r.find(".so-widgets-image-results"),s=function(t,i){r.find(".so-widgets-results-loading").fadeIn("fast"),r.find(".so-widgets-results-loading strong").html(r.find(".so-widgets-results-loading strong").data("loading")),r.find(".so-widgets-results-more").hide(),e.get(ajaxurl,{action:"so_widgets_image_search",q:t,page:i,_sononce:r.find('input[name="_sononce"]').val()},(function(n){n.error?alert(n.message):(a.removeClass("so-loading"),e.each(n.items,(function(t,i){var n=e(e("#so-widgets-bundle-tpl-image-search-result").html().trim()).appendTo(a).addClass("source-"+i.source).find(".so-widgets-result-image");n.css("background-image","url("+i.thumbnail+")"),n.data("thumbnail",i.thumbnail),n.data("preview",i.preview),i.url&&n.attr({href:i.url,target:"_blank"}),i.full_url&&(n.data({full_url:i.full_url,import_signature:i.import_signature}),n.attr("href",i.full_url)),"shutterstock"===i.source&&n.append(e("#so-widgets-bundle-tpl-image-search-result-sponsored").html())})),1===i&&(r.find("#so-widgets-image-search-suggestions ul").empty(),e.each(n.keywords,(function(t,i){r.find("#so-widgets-image-search-suggestions").show(),r.find("#so-widgets-image-search-suggestions ul").append(e("<li></li>").append(e('<a href="#"></a>').html(i).data("keyword",i)))}))),r.find(".so-widgets-results-loading").fadeOut("fast"),o(),r.find(".so-widgets-results-more").show().find("button").data({query:t,page:i+1}))}))};r.find("#so-widgets-image-search-form").on("submit",(function(e){e.preventDefault();var t=r.find(".so-widgets-search-input").val();a.empty(),""!==t&&s(t,1)})),r.on("click",".so-keywords-list a",(function(t){t.preventDefault();var i=e(this).trigger("blur");r.find(".so-widgets-search-input").val(i.data("keyword")),r.find("#so-widgets-image-search-form").trigger("submit")})),r.find(".so-widgets-results-more button").on("click",(function(){var t=e(this);s(t.data("query"),t.data("page"))})),r.on("click",".so-widgets-result-image",(function(t){var a=e(this);if(a.data("full_url")&&(t.preventDefault(),confirm(r.data("confirm-import")))){r.addClass("so-widgets-importing");var s=e("#post_ID").val();null===s&&(s=""),e.get(ajaxurl,{action:"so_widgets_image_import",full_url:a.data("full_url"),import_signature:a.data("import_signature"),post_id:s,_sononce:r.find('input[name="_sononce"]').val()},(function(e){r.find("#so-widgets-image-search-frame").removeClass("so-widgets-importing"),!1===e.error?(r.hide(),r.find(".so-widgets-results-loading").hide(),n.val(e.attachment_id).trigger("change",{silent:!0}),i.find(".current .thumbnail").attr("src",e.thumb).fadeIn(),i.find(".media-remove-button").removeClass("remove-hide").attr("tabindex",0)):(alert(e.message),r.find(".so-widgets-results-loading").hide())})),r.find(".so-widgets-results-loading").fadeIn("fast"),r.find(".so-widgets-results-loading strong").html(r.find(".so-widgets-results-loading strong").data("importing")),r.find(".so-widgets-results-more").hide(),r.find("#so-widgets-image-search-frame").addClass("so-widgets-importing")}}));var d,l,u=r.find(".so-widgets-preview-window");r.on("mouseenter",".so-widgets-result-image",(function(){var i=e(this),a=i.data("preview");clearTimeout(t),t=setTimeout((function(){var t=1,n=1;a[1]>.33*e(window).outerWidth()&&(t=.33*e(window).outerWidth()/a[1]),a[2]>.5*e(window).outerHeight()&&(n=.5*e(window).outerHeight()/a[2]);var s=Math.min(t,n);s>1&&(s=1),u.show().find(".so-widgets-preview-window-inside").css({"background-image":"url("+i.data("thumbnail")+")",width:a[1]*s+"px",height:a[2]*s+"px"}).append(e("<img />").attr("src",a[0])),r.trigger("mousemove")}),1e3)})).on("mouseleave",".so-widgets-result-image",(function(){u.hide().find("img").remove(),clearTimeout(t)})),r.on("mousemove",(function(t){if(t.clientX&&(d=t.clientX),t.clientY&&(l=t.clientY),u.is(":visible")){var i=u.outerHeight(),a=u.outerWidth(),n=e(window).outerHeight(),s=e(window).outerWidth(),r=l-i/2;r=Math.max(r,10),r=Math.min(r,n-10-i);var o=d<s/2?d+15:d-15-a;u.css({top:r+"px",left:o+"px"})}}))}r.show(),r.find(".so-widgets-search-input").trigger("focus")}()})),n.on("change",(function(e,t){if(!t||!t.silent){var a=n.val();if(a){var r=i.find(".current .thumbnail"),o=wp.media.attachment(a);o.fetch().done((function(){if(o.has("sizes")){var e=o.get("sizes");void 0!==e.thumbnail?r.attr("src",e.thumbnail.url).fadeIn():r.attr("src",e.full.url).fadeIn()}else r.attr("src",o.get("icon")).fadeIn();i.find(".media-remove-button").removeClass("remove-hide").attr("tabindex",0)}))}else i.find("a.media-remove-button").trigger("click")}void 0!==t&&t.external||s.trigger("change",{internal:!0})})),s.on("change",(function(t,i){e(t.currentTarget).hasClass("media-fallback-external")||void 0!==i&&i.internal||n.trigger("change",{external:!0})})),a.data("initialized",!0)}}))}(jQuery);